<!DOCTYPE html>
<html>
<head>
    <style>
    body {
        font-family: 'Helvetica', 'Arial', sans-serif;
        color: #444444;
        background-color: #FAFAFA;
        max-width: 48rem;
        text-align: justify;
        margin-left: auto;
        margin-right: auto;
    }

    h1 {
        text-align: center;
    }

    h4 a {
        font-size: 0.8rem;
    }
</style></head>
<body>
    <main class="page-content" aria-label="Content">
        <div class="wrapper">
          <link href="/css/override.css" rel="stylesheet" type="text/css">
  <article class="post h-entry" itemscope="" itemtype="http://schema.org/BlogPosting">
  
    <header class="post-header">
      <h1 class="post-title p-name" itemprop="name headline">NestJS OpenAPI Docs Tests</h1>
      <p class="post-meta">
        <time class="dt-published" datetime="2023-04-10T00:00:00+00:00" itemprop="datePublished">Apr 10, 2023
        </time>
        • <span itemprop="author" itemscope="" itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Ian Grainger</span></span></p>
    </header>
  
    <div class="post-content e-content" itemprop="articleBody">
      <p>Writing front-end code to talk to a back-end is so much easier with an autogenerated client. We can use an OpenAPI spec document to generate this client code.</p>
  
  <p>But how do we check that we aren’t breaking these clients, that the front-end code relies on when making changes to the back end code?</p>
  
  <p>When using <a href="https://docs.nestjs.com/">NestJS</a> it is easy to add decorators on controller methods which will be used to generate an OpenAPI spec document. But to test that we are producing the document we expect, and that we don’t accidentally break something, we can add unit tests.</p>
  
  <p>This also has the advantage of documenting for the front-end developers what the API looks like.</p>
  
  <h2 id="example">Example</h2>
  
  <p>After running the <a href="https://docs.nestjs.com/first-steps">NestJS quickstart</a>, then adding the <a href="https://docs.nestjs.com/openapi/introduction">NestJS OpenAPI bootstrap code</a>, we can move the document creation code into its own function - in its own file:</p>
  
  <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">createApiDoc</span><span class="p">(</span><span class="nx">app</span><span class="p">:</span> <span class="nx">INestApplication</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DocumentBuilder</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">setTitle</span><span class="p">(</span><span class="dl">'</span><span class="s1">Cats example</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">setDescription</span><span class="p">(</span><span class="dl">'</span><span class="s1">The cats API description</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">setVersion</span><span class="p">(</span><span class="dl">'</span><span class="s1">1.0</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">addTag</span><span class="p">(</span><span class="dl">'</span><span class="s1">cats</span><span class="dl">'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">build</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nb">document</span> <span class="o">=</span> <span class="nx">SwaggerModule</span><span class="p">.</span><span class="nx">createDocument</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">document</span><span class="p">;</span>
  <span class="p">}</span>
  </code></pre></div></div>
  
  <p>Then we can write a test to create the doc and check that a section looks as it should - this one will test the <code class="language-plaintext highlighter-rouge">SutController</code> class - which depends on a service called <code class="language-plaintext highlighter-rouge">ExampleService</code>:</p>
  
  <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">app</span><span class="p">:</span> <span class="nx">INestApplication</span><span class="p">;</span>
  <span class="nx">beforeAll</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="kr">module</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Test</span><span class="p">.</span><span class="nx">createTestingModule</span><span class="p">({</span>
      <span class="na">controllers</span><span class="p">:</span> <span class="p">[</span><span class="nx">SutController</span><span class="p">],</span>
      <span class="na">providers</span><span class="p">:</span> <span class="p">[</span><span class="nx">ExampleService</span><span class="p">],</span>
    <span class="p">})</span>
      <span class="p">.</span><span class="nx">overrideProvider</span><span class="p">(</span><span class="nx">ExampleService</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">useValue</span><span class="p">({</span> <span class="na">getHello</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="dl">'</span><span class="s1">Hello World!</span><span class="dl">'</span> <span class="p">})</span>
      <span class="p">.</span><span class="nx">compile</span><span class="p">();</span>
    <span class="nx">app</span> <span class="o">=</span> <span class="k">await</span> <span class="kr">module</span><span class="p">.</span><span class="nx">createNestApplication</span><span class="p">();</span>
  <span class="p">});</span>
  
  <span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">hello API docs operationId should be AppController_getHello</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">docs</span> <span class="o">=</span> <span class="nx">createApiDoc</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
  
    <span class="nx">expect</span><span class="p">(</span><span class="nx">docs</span><span class="p">).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="na">paths</span><span class="p">:</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span> <span class="na">get</span><span class="p">:</span> <span class="p">{</span> <span class="na">operationId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">AppController_getHello</span><span class="dl">'</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">});</span>
  <span class="p">});</span>
  </code></pre></div></div>
  
  <p>If we add the operationID to an ApiOperation decorator on the controller method, like this:</p>
  
  <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Get</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ApiOperation</span><span class="p">({</span> <span class="na">operationId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">hello</span><span class="dl">"</span> <span class="p">})</span>
  <span class="nx">getHello</span><span class="p">():</span> <span class="kr">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">appService</span><span class="p">.</span><span class="nx">getHello</span><span class="p">();</span>
  <span class="p">}</span>
  </code></pre></div></div>
  
  <p>Then the test should fail, and we can fix it by updating the test to match the new operationId, like this:</p>
  
  <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">hello API docs operationId should be hello</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">docs</span> <span class="o">=</span> <span class="nx">createApiDoc</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
  
    <span class="nx">expect</span><span class="p">(</span><span class="nx">docs</span><span class="p">).</span><span class="nx">toMatchObject</span><span class="p">({</span>
      <span class="na">paths</span><span class="p">:</span> <span class="p">{</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span> <span class="na">get</span><span class="p">:</span> <span class="p">{</span> <span class="na">operationId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">});</span>
  <span class="p">});</span>
  </code></pre></div></div>
  
  <p>This way we can demonstrate that the API is working as expected, and also document what the API looks like.</p>
  
  <h2 id="complex-response-types">Complex response types</h2>
  
  <p>Usually to document a NestJS API, we’d add the NestJS Swagger plugin, which will automatically include default responses in the document. But this only works <a href="https://github.com/nestjs/swagger/issues/1123">when running from the command line</a>, so we can’t use it in our unit tests 😔</p>
  
  <p>That means that if we add a test that the docs include the type for a 200 response, like this:</p>
  
  <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">hello API docs should include 200 response type string</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">docs</span> <span class="o">=</span> <span class="nx">createApiDoc</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
  
    <span class="kd">const</span> <span class="nx">helloRes</span> <span class="o">=</span> <span class="nx">docs</span><span class="p">.</span><span class="nx">paths</span><span class="p">[</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">].</span><span class="kd">get</span><span class="p">.</span><span class="nx">responses</span><span class="p">[</span><span class="dl">'</span><span class="s1">200</span><span class="dl">'</span><span class="p">]</span> <span class="k">as</span> <span class="nx">ResponseObject</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">resSchema</span> <span class="o">=</span> <span class="nx">helloRes</span><span class="p">.</span><span class="nx">content</span><span class="p">?.[</span><span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">]?.</span><span class="nx">schema</span><span class="p">;</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">resSchema</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span> <span class="p">});</span>
  <span class="p">});</span>
  </code></pre></div></div>
  
  <p>Then it will fail - with the following error:</p>
  
  <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Expected</span><span class="p">:</span> <span class="p">{</span><span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">}</span>
  <span class="nl">Received</span><span class="p">:</span> <span class="kc">undefined</span>
  </code></pre></div></div>
  
  <p>To get around this limitation, we can explicitly document the default response type with an annotation. Though this is not as good as if we could use the Swagger plugin in our test of course!</p>
  
  <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Get</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">ApiOperation</span><span class="p">({</span> <span class="na">operationId</span><span class="p">:</span> <span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span> <span class="p">})</span>
  <span class="p">@</span><span class="nd">ApiResponse</span><span class="p">({</span> <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span> <span class="p">})</span>
  <span class="nx">getHello</span><span class="p">():</span> <span class="kr">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">appService</span><span class="p">.</span><span class="nx">getHello</span><span class="p">();</span>
  <span class="p">}</span>
  </code></pre></div></div>
  
  <p>But now we have another passing test! 🥳 We have also documented the API in the tests, and prevented regressions. Time for a coffee! ☕</p>
  </article>
        </div>
      </main>
</body>
</html>
